<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyMoments - Google Photos Style</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        google: {
                            blue: '#1a73e8',
                            blueDark: '#8ab4f8',
                            gray: '#f1f3f4',
                            grayDark: '#303134',
                            bgDark: '#202124',
                            textDark: '#e8eaed',
                            textLight: '#3c4043'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"
      }
    }
    </script>

    <!-- 3. Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Google Sans', Roboto, Arial, sans-serif; }
        
        /* Google Photos Style Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #5f6368; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-white dark:bg-google-bgDark text-google-textLight dark:text-google-textDark transition-colors duration-300 overflow-hidden">

    <div id="root"></div>

    <!-- 4. Main Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, Upload, X, Heart, User, Plus, 
            Image as ImageIcon, Loader2, Sparkles, 
            BookOpen, ArrowLeft, Grid, Users, 
            ChevronLeft, ChevronRight, Sun, Moon, 
            LogOut, Trash2, AlertCircle, LogIn,
            Download, Share2, Search, Menu, Settings
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc,
            updateDoc,
            deleteDoc,
            increment,
            serverTimestamp
        } from 'firebase/firestore';

        // ==========================================
        // ⚠️ CONFIGURATION SECTION ⚠️
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCM_Q_rfnJHekGWXYGHcTKWm29VYChpxSg",
            authDomain: "family-album-50277.firebaseapp.com",
            projectId: "family-album-50277",
            storageBucket: "family-album-50277.firebasestorage.app",
            messagingSenderId: "42635602220",
            appId: "1:42635602220:web:986c952752e3ea2e5de489",
            measurementId: "G-6WNS02QYYR"
        };

        const geminiApiKey = "AIzaSyBHYw_v94xd5OkTn2sUn95qUrabA3VwtL4";

        const appId = 'family-moments-web'; 

        // ==========================================
        // END CONFIGURATION
        // ==========================================

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const callGemini = async (payload) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate content.";
            } catch (error) {
                console.error(error);
                return "Error generating content.";
            }
        };

        // UPDATED COMPRESSION: More aggressive to stay under 1MB Firestore Limit
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Reduced max size to 800 to prevent "Document too large" errors
                        const MAX_WIDTH = 800; 
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Reduced quality to 0.6
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const formatDateHeader = (timestamp) => {
            if (!timestamp) return 'Recent';
            const date = new Date(timestamp.toMillis());
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            return date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        };

        // --- Sub Components ---

        const SearchBar = ({ className }) => (
            <div className={`relative flex items-center w-full max-w-2xl bg-google-gray dark:bg-google-grayDark rounded-lg px-4 py-3 transition-colors ${className}`}>
                <Search className="text-gray-500 dark:text-gray-400 mr-3" size={20} />
                <input 
                    type="text" 
                    placeholder="Search your photos" 
                    className="bg-transparent border-none outline-none w-full text-google-textLight dark:text-google-textDark placeholder-gray-500 dark:placeholder-gray-400"
                />
            </div>
        );

        const Logo = () => (
            <div className="flex items-center gap-2 select-none">
                <div className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                    <div className="w-4 h-4 border-2 border-white rounded-full transform rotate-45"></div>
                </div>
                <span className="text-xl font-normal text-gray-600 dark:text-gray-200 tracking-tight">Photos</span>
            </div>
        );

        const SidebarItem = ({ icon: Icon, label, isActive, onClick }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-4 px-6 py-3 rounded-r-full text-sm font-medium transition-colors ${
                    isActive 
                    ? 'bg-blue-50 dark:bg-blue-900/20 text-google-blue dark:text-google-blueDark' 
                    : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'
                }`}
            >
                <Icon size={20} className={isActive ? "fill-current" : ""} />
                {label}
            </button>
        );

        const PhotoCard = ({ photo, onLike, onClick }) => (
            <div 
                className="relative group aspect-square bg-gray-100 dark:bg-gray-800 cursor-pointer overflow-hidden rounded-sm"
                onClick={() => onClick(photo)}
            >
                <img 
                    src={photo.image} 
                    alt={photo.caption} 
                    className="w-full h-full object-cover transition-opacity duration-200 hover:opacity-90"
                    loading="lazy"
                />
                {/* Overlay only on hover for desktop, always minimal on mobile if needed */}
                <div className="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex flex-col justify-end p-2">
                     <div className="flex justify-between items-center text-white">
                        <span className="text-xs font-medium truncate">{photo.uploader}</span>
                        <button onClick={(e) => { e.stopPropagation(); onLike(photo.id); }} className="p-1 hover:bg-white/20 rounded-full">
                             <Heart size={16} className={photo.likes > 0 ? "fill-rose-500 text-rose-500" : "text-white"} />
                        </button>
                    </div>
                </div>
                {photo.likes > 0 && (
                    <div className="absolute top-2 right-2 bg-black/50 backdrop-blur-md rounded-full px-2 py-0.5 flex items-center gap-1 text-[10px] text-white md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                        <Heart size={8} className="fill-white" /> {photo.likes}
                    </div>
                )}
            </div>
        );

        const ImageViewer = ({ photo, currentUser, onClose, onNext, onPrev, hasNext, hasPrev, onDelete }) => {
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            
            // Guard clause: if photo is null, don't render anything
            if (!photo) return null;

            const isOwner = currentUser && photo.userId === currentUser.uid;

            const handleDownload = () => {
                const link = document.createElement('a');
                link.href = photo.image;
                link.download = `photo-${photo.id}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black flex flex-col animate-in fade-in duration-200">
                    <div className="flex justify-between items-center p-4 bg-black/40 backdrop-blur-sm absolute top-0 left-0 right-0 z-10">
                        <button onClick={onClose} className="p-2 text-white rounded-full hover:bg-white/10">
                            <ArrowLeft size={24} />
                        </button>
                        <div className="flex gap-4">
                            <button onClick={handleDownload} className="p-2 text-white rounded-full hover:bg-white/10"><Download size={20} /></button>
                            {isOwner && <button onClick={() => setShowDeleteConfirm(true)} className="p-2 text-white rounded-full hover:bg-white/10"><Trash2 size={20} /></button>}
                        </div>
                    </div>
                    
                    <div className="flex-1 flex items-center justify-center relative overflow-hidden">
                         {hasPrev && <button onClick={(e) => { e.stopPropagation(); onPrev(); }} className="absolute left-4 p-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/50 rounded-full transition-all"><ChevronLeft size={32}/></button>}
                         <img src={photo.image} className="max-w-full max-h-full object-contain" />
                         {hasNext && <button onClick={(e) => { e.stopPropagation(); onNext(); }} className="absolute right-4 p-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/50 rounded-full transition-all"><ChevronRight size={32}/></button>}
                    </div>

                    <div className="bg-black/80 backdrop-blur-md text-white p-6">
                         <div className="max-w-2xl mx-auto">
                            {photo.caption && <p className="text-lg mb-2">{photo.caption}</p>}
                            <div className="flex items-center gap-3 text-sm text-gray-400">
                                <div className="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs">{photo.uploader[0]}</div>
                                <span>{photo.uploader}</span>
                                <span>•</span>
                                <span>{photo.timestamp ? new Date(photo.timestamp.toMillis()).toLocaleDateString() : ''}</span>
                            </div>
                         </div>
                    </div>

                    {showDeleteConfirm && (
                        <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                            <div className="bg-google-bgDark border border-gray-700 p-6 rounded-lg max-w-xs w-full text-center">
                                <h3 className="text-white font-medium mb-4">Move to trash?</h3>
                                <div className="flex justify-end gap-4">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="text-blue-400 hover:text-blue-300 font-medium">Cancel</button>
                                    <button onClick={() => { onDelete(photo.id); setShowDeleteConfirm(false); }} className="text-blue-400 hover:text-blue-300 font-medium">Move to trash</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const UploadModal = ({ isOpen, onClose, onUpload, isUploading, currentUser }) => {
            const [files, setFiles] = useState([]);
            const [previews, setPreviews] = useState([]);
            const [caption, setCaption] = useState('');
            const [uploaderName, setUploaderName] = useState(currentUser?.displayName || '');
            const [isMagic, setIsMagic] = useState(false);

            useEffect(() => {
                if (!currentUser?.displayName) {
                    setUploaderName(localStorage.getItem('family_app_username') || '');
                }
            }, [currentUser]);

            const handleFileChange = (e) => {
                const selected = Array.from(e.target.files);
                if (selected.length) {
                    setFiles(selected);
                    const newPreviews = [];
                    selected.forEach(f => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            newPreviews.push(reader.result);
                            if (newPreviews.length === selected.length) setPreviews(newPreviews);
                        };
                        reader.readAsDataURL(f);
                    });
                }
            };

            const handleMagicCaption = async () => {
                if (!files.length) return;
                setIsMagic(true);
                try {
                    const compressed = await compressImage(files[0]);
                    const b64 = compressed.split(',')[1];
                    const txt = await callGemini({
                        contents: [{ role: "user", parts: [{ text: "Write a very short, natural caption for this photo." }, { inlineData: { mimeType: "image/jpeg", data: b64 } }] }]
                    });
                    setCaption(txt.trim());
                } catch (e) { console.error(e); }
                setIsMagic(false);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!files.length || !uploaderName) return;
                if (!currentUser.displayName) localStorage.setItem('family_app_username', uploaderName);
                onUpload({ files, caption, uploaderName });
                setFiles([]); setPreviews([]); setCaption(''); onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-white dark:bg-google-bgDark w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                            <h2 className="text-lg font-google text-gray-800 dark:text-gray-200">Upload photos</h2>
                            <button onClick={onClose}><X className="text-gray-500" /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div className="flex justify-center">
                                <label className="cursor-pointer group relative flex flex-col items-center gap-2">
                                    <input type="file" multiple accept="image/*" onChange={handleFileChange} className="hidden" />
                                    {previews.length > 0 ? (
                                        <div className="grid grid-cols-3 gap-2">
                                            {previews.slice(0, 3).map((src, i) => (
                                                <img key={i} src={src} className="w-24 h-24 object-cover rounded-lg shadow-md" />
                                            ))}
                                            {previews.length > 3 && <div className="w-24 h-24 bg-gray-100 flex items-center justify-center rounded-lg text-gray-500">+{previews.length - 3}</div>}
                                        </div>
                                    ) : (
                                        <div className="w-full h-32 bg-blue-50 dark:bg-blue-900/10 border-2 border-dashed border-blue-200 dark:border-blue-800 rounded-xl flex flex-col items-center justify-center text-blue-600 px-12">
                                            <ImageIcon size={32} className="mb-2" />
                                            <span className="text-sm font-medium">Select photos</span>
                                        </div>
                                    )}
                                </label>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs font-medium text-gray-500 uppercase">Who is this?</label>
                                    <input 
                                        type="text" 
                                        value={uploaderName} 
                                        onChange={e => setUploaderName(e.target.value)}
                                        className="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 rounded-md border-none outline-none text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                                        placeholder="Your Name"
                                    />
                                </div>
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <label className="text-xs font-medium text-gray-500 uppercase">Caption</label>
                                        {previews.length > 0 && <button type="button" onClick={handleMagicCaption} className="text-xs text-blue-500 flex items-center gap-1">{isMagic ? <Loader2 className="animate-spin" size={12}/> : <Sparkles size={12}/>} AI Caption</button>}
                                    </div>
                                    <input 
                                        type="text" 
                                        value={caption} 
                                        onChange={e => setCaption(e.target.value)}
                                        className="w-full p-2 bg-gray-100 dark:bg-gray-800 rounded-md border-none outline-none text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500"
                                        placeholder="Add a caption..."
                                    />
                                </div>
                            </div>

                            <div className="flex justify-end">
                                <button type="submit" disabled={isUploading || !files.length} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-medium transition-colors disabled:opacity-50 flex items-center gap-2">
                                    {isUploading ? <Loader2 className="animate-spin" size={18} /> : 'Upload'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main Layout Component ---

        function FamilyApp() {
            const [user, setUser] = useState(null);
            const [photos, setPhotos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('photos');
            const [isUploadOpen, setIsUploadOpen] = useState(false);
            const [viewingPhoto, setViewingPhoto] = useState(null);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [story, setStory] = useState('');
            const [isStoryOpen, setIsStoryOpen] = useState(false);
            const [isUserMenuOpen, setIsUserMenuOpen] = useState(false);

            useEffect(() => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    setIsDarkMode(true);
                }
            }, []);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', isDarkMode);
            }, [isDarkMode]);

            useEffect(() => {
                onAuthStateChanged(auth, u => { setUser(u); if(!u) setLoading(false); });
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'family_photos'), snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    setPhotos(list);
                    setLoading(false);
                });
                return () => unsub();
            }, [user]);

            const handleUpload = async (data) => {
                try {
                    await Promise.all(data.files.map(async f => {
                        const b64 = await compressImage(f);
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'family_photos'), {
                            image: b64, caption: data.caption, uploader: data.uploader, likes: 0, timestamp: serverTimestamp(), userId: user.uid
                        });
                    }));
                } catch (e) { 
                    // Better Error Reporting
                    console.error(e);
                    alert("Upload failed: " + e.message); 
                }
            };

            const handleStory = async () => {
                if (!photos.length) return;
                setIsStoryOpen(true);
                setStory("Generating...");
                try {
                    const context = photos.slice(0, 10).map(p => p.caption || 'Photo').join(', ');
                    const txt = await callGemini({ contents: [{ parts: [{ text: `Write a heartwarming 2-sentence summary of these family memories: ${context}` }] }] });
                    setStory(txt);
                } catch (e) { setStory("Failed to generate."); }
            };

            const handleDelete = async (id) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_photos', id));
                setViewingPhoto(null);
            };

            const dateGroups = useMemo(() => {
                const g = {};
                photos.forEach(p => {
                    const d = formatDateHeader(p.timestamp);
                    if(!g[d]) g[d] = [];
                    g[d].push(p);
                });
                return g;
            }, [photos]);

            if (!user && !loading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                         <div className="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-6">
                             <div className="w-8 h-8 border-2 border-white rounded-full transform rotate-45"></div>
                         </div>
                         <h1 className="text-2xl font-normal text-gray-800 dark:text-white mb-8">Sign in to FamilyMoments</h1>
                         <button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-blue-600 text-white px-8 py-3 rounded-full font-medium hover:bg-blue-700 transition-colors mb-4">Sign in with Google</button>
                         <button onClick={() => signInAnonymously(auth)} className="text-blue-600 hover:bg-blue-50 px-6 py-2 rounded-full font-medium transition-colors">Continue as Guest</button>
                    </div>
                );
            }

            return (
                <div className="flex h-screen w-screen bg-white dark:bg-google-bgDark overflow-hidden">
                    
                    {/* LEFT SIDEBAR (Desktop) */}
                    <div className="hidden md:flex w-64 flex-col p-4 h-full border-r border-transparent">
                        <div className="pl-4 mb-8 mt-2"><Logo /></div>
                        
                        {/* Sidebar Nav */}
                        <div className="flex-1 space-y-1">
                            <SidebarItem icon={ImageIcon} label="Photos" isActive={activeTab === 'photos'} onClick={() => setActiveTab('photos')} />
                            <SidebarItem icon={Users} label="People" isActive={activeTab === 'people'} onClick={() => setActiveTab('people')} />
                            <SidebarItem icon={BookOpen} label="Story" isActive={false} onClick={handleStory} />
                        </div>

                        {/* Desktop Dark Mode Toggle */}
                        <div className="px-4 mb-4">
                             <button onClick={() => setIsDarkMode(!isDarkMode)} className="flex items-center gap-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                 {isDarkMode ? <Sun size={18}/> : <Moon size={18}/>}
                                 <span className="text-sm">Theme</span>
                             </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 flex flex-col h-full relative">
                        
                        {/* TOP BAR (Desktop: Search, Mobile: Search+Logo) */}
                        <header className="h-16 flex items-center justify-between px-4 md:px-8 bg-white/90 dark:bg-google-bgDark/90 backdrop-blur-sm z-20 sticky top-0">
                            <div className="md:hidden"><Logo /></div>
                            
                            {/* Search Bar (Center on desktop, hidden on very small mobile) */}
                            <div className="hidden md:flex flex-1 justify-center px-8">
                                <SearchBar />
                            </div>

                            {/* Profile & Upload (Desktop) */}
                            <div className="flex items-center gap-3">
                                <button onClick={() => setIsUploadOpen(true)} className="hidden md:flex bg-white dark:bg-google-grayDark border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-google-blue dark:text-google-blueDark px-4 py-2 rounded-md text-sm font-medium items-center gap-2 transition-colors">
                                    <Upload size={18} /> Upload
                                </button>

                                {/* Profile Menu */}
                                <div className="relative">
                                    <button onClick={() => setIsUserMenuOpen(!isUserMenuOpen)} className="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-medium overflow-hidden ring-2 ring-transparent hover:ring-gray-300 dark:hover:ring-gray-600 transition-all">
                                        {user?.photoURL ? <img src={user.photoURL} className="w-full h-full" /> : user?.displayName?.[0] || 'U'}
                                    </button>
                                    {isUserMenuOpen && (
                                        <>
                                            <div className="fixed inset-0 z-40" onClick={() => setIsUserMenuOpen(false)} />
                                            <div className="absolute right-0 top-10 w-64 bg-white dark:bg-google-grayDark rounded-xl shadow-2xl border border-gray-100 dark:border-gray-700 z-50 p-4 animate-in fade-in">
                                                <div className="flex flex-col items-center mb-4">
                                                    <div className="w-16 h-16 rounded-full bg-purple-600 text-white flex items-center justify-center text-2xl mb-2">
                                                        {user?.photoURL ? <img src={user.photoURL} className="w-full h-full rounded-full" /> : user?.displayName?.[0] || 'U'}
                                                    </div>
                                                    <p className="font-medium text-gray-800 dark:text-white">{user?.displayName || 'Guest'}</p>
                                                    <p className="text-sm text-gray-500">{user?.email}</p>
                                                </div>
                                                <button onClick={() => signOut(auth)} className="w-full py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                    Sign out
                                                </button>
                                                <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between text-xs text-gray-500">
                                                    <span>Privacy Policy</span>
                                                    <span>Terms of Service</span>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </header>

                        {/* Mobile Search Bar (Below header) */}
                        <div className="md:hidden px-4 pb-2">
                            <SearchBar className="w-full" />
                        </div>

                        {/* SCROLLABLE CONTENT */}
                        <div className="flex-1 overflow-y-auto px-0 md:px-4 pb-24 md:pb-4">
                            {loading ? (
                                <div className="flex flex-col items-center justify-center h-64">
                                    <div className="w-12 h-1 bg-blue-200 rounded-full overflow-hidden">
                                        <div className="w-full h-full bg-blue-600 animate-progress origin-left"></div>
                                    </div>
                                </div>
                            ) : activeTab === 'photos' ? (
                                <div className="space-y-6">
                                    {Object.entries(dateGroups).map(([date, groupPhotos]) => (
                                        <div key={date}>
                                            <div className="sticky top-0 z-10 bg-white/95 dark:bg-google-bgDark/95 backdrop-blur-sm py-4 px-4 md:px-0 flex items-center">
                                                <h3 className="text-sm font-medium text-gray-800 dark:text-gray-200">{date}</h3>
                                            </div>
                                            <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-1 md:gap-4 px-0 md:px-0">
                                                {groupPhotos.map(p => (
                                                    <PhotoCard key={p.id} photo={p} onLike={async () => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_photos', p.id), {likes: increment(1)})} onClick={setViewingPhoto} />
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {photos.length === 0 && (
                                        <div className="text-center py-20">
                                            <div className="inline-block p-4 rounded-full bg-gray-100 dark:bg-gray-800 mb-4"><ImageIcon size={48} className="text-gray-400"/></div>
                                            <h3 className="text-xl font-normal text-gray-600 dark:text-gray-400">No photos yet</h3>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="p-4">
                                    <h2 className="text-lg font-normal mb-4">People</h2>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {/* People grouping logic reuse */}
                                        {Array.from(new Set(photos.map(p => p.uploader))).map(person => {
                                            const count = photos.filter(p => p.uploader === person).length;
                                            const latest = photos.find(p => p.uploader === person)?.image;
                                            return (
                                                <div key={person} className="aspect-square rounded-2xl overflow-hidden relative group cursor-pointer border border-gray-200 dark:border-gray-700">
                                                    <img src={latest} className="w-full h-full object-cover group-hover:scale-105 transition-transform" />
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex flex-col justify-end p-3">
                                                        <span className="text-white font-medium">{person}</span>
                                                        <span className="text-gray-300 text-xs">{count} items</span>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* MOBILE BOTTOM NAV */}
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-google-bgDark border-t border-gray-200 dark:border-gray-800 px-6 py-2 flex justify-between items-center z-30 safe-area-pb">
                            <button onClick={() => setActiveTab('photos')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'photos' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500'}`}>
                                <ImageIcon size={24} className={activeTab === 'photos' ? 'fill-current' : ''} />
                                <span className="text-xs font-medium">Photos</span>
                            </button>
                            <button onClick={() => setActiveTab('people')} className={`flex flex-col items-center gap-1 p-2 ${activeTab === 'people' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500'}`}>
                                <Users size={24} className={activeTab === 'people' ? 'fill-current' : ''} />
                                <span className="text-xs font-medium">Search</span>
                            </button>
                             <button onClick={() => setIsDarkMode(!isDarkMode)} className="flex flex-col items-center gap-1 p-2 text-gray-500">
                                {isDarkMode ? <Sun size={24} /> : <Moon size={24} />}
                                <span className="text-xs font-medium">Theme</span>
                            </button>
                        </div>
                        
                        {/* MOBILE FAB (Floating Action Button) */}
                        <button onClick={() => setIsUploadOpen(true)} className="md:hidden fixed bottom-20 right-4 w-14 h-14 bg-white dark:bg-google-grayDark text-google-blue shadow-xl rounded-2xl flex items-center justify-center z-30 border border-gray-100 dark:border-gray-700">
                             <div className="w-8 h-8 relative">
                                 {/* Google colored plus icon simulation */}
                                 <Plus size={32} strokeWidth={2.5} />
                             </div>
                        </button>

                    </div>

                    {/* MODALS */}
                    <UploadModal isOpen={isUploadOpen} onClose={() => setIsUploadOpen(false)} onUpload={handleUpload} isUploading={false} currentUser={user} />
                    
                    {/* Added conditional rendering here: 
                       ImageViewer is now only rendered if viewingPhoto is NOT null.
                       This prevents passing null to ImageViewer and causing the crash.
                    */}
                    {viewingPhoto && (
                        <ImageViewer 
                            photo={viewingPhoto} 
                            currentUser={user} 
                            onClose={() => setViewingPhoto(null)} 
                            hasNext={false} 
                            hasPrev={false} 
                            onDelete={handleDelete} 
                        />
                    )}
                    
                    {/* Story Popup */}
                    {isStoryOpen && (
                        <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in">
                            <div className="bg-white dark:bg-google-bgDark w-full max-w-md rounded-3xl p-8 shadow-2xl relative">
                                <button onClick={() => setIsStoryOpen(false)} className="absolute top-4 right-4 p-2 bg-gray-100 dark:bg-gray-800 rounded-full"><X size={20}/></button>
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 rounded-full flex items-center justify-center mb-6">
                                        <Sparkles size={32} />
                                    </div>
                                    <h2 className="text-xl font-google mb-4">Your Family Story</h2>
                                    <p className="text-gray-600 dark:text-gray-300 leading-relaxed font-serif text-lg italic">
                                        {story === 'Generating...' ? <span className="flex items-center justify-center gap-2"><Loader2 className="animate-spin"/> Writing...</span> : story}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FamilyApp />);
    </script>
</body>
</html>